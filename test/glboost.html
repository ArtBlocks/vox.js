<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, height=device-height, user-scalable=no, initial-scale=1, maximum-scale=1">
</head>

<body>
  <canvas id="world" width="500" height="500"></canvas>
  <script src="libs/glboost.js"></script>
  <script src="../build/vox.js"></script>
  <script src="../src/glboostmeshbuilder.js"></script>
  <script>
  var vec3 = GLBoost.Vector3;
  var vec4 = GLBoost.Vector4;

  GLBoost.TARGET_WEBGL_VERSION = 1;

  var canvas = document.getElementById("world");

  var glBoostContext = new GLBoost.GLBoostMiddleContext(canvas);
  var renderer = glBoostContext.createRenderer({
    canvas: canvas,
    clearColor: {
      red: 0.25,
      green: 0.25,
      blue: 0.25,
      alpha: 1
    }
  });

  var scene = glBoostContext.createScene();

  var light = glBoostContext.createDirectionalLight(new vec3(1.0, 1.0, 1.0), new vec3(1.0, -1.0, 1.0), "#world");
  scene.addChild(light);

  var material = glBoostContext.createClassicMaterial();
  material.shaderClass = GLBoost.PhongShader;

  var cubeGeometry = glBoostContext.createCube(new vec3(1.0, 1.0, 1.0), new vec3(1.0, 1.0, 1.0));
  var cube0 = glBoostContext.createMesh(cubeGeometry, material);
  cube0.rotate.x = 0.1;
  scene.addChild(cube0);

  var parser = new vox.Parser();
  var parseTasks = [
    "vox/ship.vox",
  ].map(function(path) {
    return parser.parse(path);
  });

  Promise
    .all(parseTasks)
    .then(function(voxelDataArray) {
      voxelDataArray.forEach(function(voxelData, i) {
        var builder = new vox.GLBoostMeshBuilder(glBoostContext, voxelData, {
          voxelSize: 1.8,
          vertexColor: false,
          optimizeFaces: true,
        });
        mesh = builder.createMesh();
        scene.addChild(mesh);
      });
    });

  var camera = glBoostContext.createCamera({
    eye: new vec4(0.0, 10, 0, 1),
    center: new vec3(0.0, 0.0, 0.0),
    up: new vec3(0.0, 0.0, -1.0)
  }, {
    fovy: 45.0,
    aspect: 1.0,
    zNear: 0.1,
    zFar: 300.0
  });
  scene.addChild(camera);

  var expression = glBoostContext.createExpressionAndRenderPasses(1);
  expression.renderPasses[0].scene = scene;
  expression.prepareToRender();

  var render = function() {
    renderer.clearCanvas();
    renderer.draw(expression);

    cube0.rotate.x += 0.1;
    cube0.rotate.y += 0.3;
    cube0.rotate.z += 0.5;
    cube0._needUpdate();

    requestAnimationFrame(render);
  };
  render();
  </script>
</body>

</html>
