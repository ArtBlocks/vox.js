<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, height=device-height, user-scalable=no, initial-scale=1, maximum-scale=1">
</head>

<body>
  <canvas id="world" width="500" height="500"></canvas>
  <script src="libs/glboost.js"></script>
  <script src="../build/vox.js"></script>
  <script>
  var vec3 = GLBoost.Vector3;
  var vec4 = GLBoost.Vector4;

  GLBoost.TARGET_WEBGL_VERSION = 1;

  var canvas = document.getElementById("world");

  var renderer = new GLBoost.Renderer({
    canvas: canvas,
    clearColor: {
      red: 0.25,
      green: 0.25,
      blue: 0.25,
      alpha: 1
    }
  });

  var scene = new GLBoost.Scene();

  var light = new GLBoost.DirectionalLight(new vec3(1.0, 1.0, 1.0), new vec3(1.0, -1.0, 1.0), "#world");
  scene.add(light);

  var material = new GLBoost.ClassicMaterial('#world');
  material.shader = new GLBoost.PhongShader(canvas);
  Promise
    .all(parseTasks)
    .then(function(voxelDataArray) {
      voxelDataArray.forEach(function(voxelData, i) {
        var builder = new vox.GLBoostGeometryBuilder(voxelData, {
          voxelSize: 1.8,
          vertexColor: false,
          optimizeFaces: true,
        });
        var mesh = builder.createMesh();

        // mesh.position.x = Math.random() * 100 - 50;
        // mesh.position.z = Math.random() * 100 - 50;

        // mesh.rotation.y = Math.random() * Math.PI * 2;

        var fv = new THREE.Vector3();
        // updateListeners.push(function(frame) {
        //     fv.set(0, 0, 0.1);
        //     fv.applyQuaternion(mesh.quaternion);
        //     mesh.position.add(fv);
        // });

        scene.add(mesh);
      });
    });

  var cubeGeometry = new GLBoost.Cube(new vec3(1.0, 1.0, 1.0), new vec3(1.0, 1.0, 1.0), '#world');
  var cube0 = new GLBoost.Mesh(cubeGeometry, material);
  cube0.rotate.x = 0.1;
  scene.add(cube0);

  var parser = new vox.Parser();
  var parseTasks = [
    "vox/ship.vox",
  ].map(function(path) {
    return parser.parse(path);
  });

  var camera = new GLBoost.Camera({
    eye: new vec4(0.0, 10, 0, 1),
    center: new vec3(0.0, 0.0, 0.0),
    up: new vec3(0.0, 0.0, -1.0)
  }, {
    fovy: 45.0,
    aspect: 1.0,
    zNear: 0.1,
    zFar: 300.0
  });
  scene.add(camera);

  scene.prepareForRender();

  var render = function() {
    renderer.clearCanvas();
    renderer.draw(scene);

    cube0.rotate.z += 0.02;
    cube0._needUpdate();

    requestAnimationFrame(render);
  };
  render();
  </script>
</body>

</html>
